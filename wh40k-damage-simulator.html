<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WH40K ダメージ確率シミュレーター</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #ff6b6b;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-size: 0.9em;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 16px;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
        }
        
        .checkbox-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            color: #b0b0b0;
        }
        
        .abilities-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        button:hover {
            background-color: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        }
        
        .results {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .results h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: #3a3a3a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .stat-label {
            color: #b0b0b0;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        #damageChart {
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            color: #4ecdc4;
            cursor: help;
            margin-left: 5px;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.9);
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 0.85em;
            z-index: 1000;
            max-width: 300px;
            white-space: normal;
        }
        
        .warning {
            background-color: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ウォーハンマー40K ダメージ確率シミュレーター</h1>
        
        <div class="main-grid">
            <div class="section">
                <h2>攻撃側プロファイル</h2>
                
                <div class="input-group">
                    <label>攻撃回数</label>
                    <input type="number" id="attacks" min="1" max="100" value="10">
                </div>
                
                <div class="input-group">
                    <label>武器スキル/射撃スキル (WS/BS) <span class="tooltip" data-tooltip="命中に必要な目標値（例：3+）">?</span></label>
                    <select id="hitRoll">
                        <option value="2">2+</option>
                        <option value="3" selected>3+</option>
                        <option value="4">4+</option>
                        <option value="5">5+</option>
                        <option value="6">6+</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>武器の攻撃力 (S)</label>
                    <input type="number" id="strength" min="1" max="20" value="4">
                </div>
                
                <div class="input-group">
                    <label>貫通 (AP)</label>
                    <input type="number" id="ap" min="-6" max="0" value="-1">
                </div>
                
                <div class="input-group">
                    <label>ダメージ (D)</label>
                    <input type="number" id="damage" min="1" max="12" value="1">
                </div>
                
                <h3 style="color: #4ecdc4; margin: 20px 0 10px 0;">武器アビリティ</h3>
                <div class="abilities-grid">
                    <div class="checkbox-group">
                        <input type="checkbox" id="sustainedHits">
                        <label for="sustainedHits">連続命中 1</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="lethalHits">
                        <label for="lethalHits">会心ヒット</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="devastatingWounds">
                        <label for="devastatingWounds">会心ウーンズ</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="twinLinked">
                        <label for="twinLinked">ツインリンク</label>
                    </div>
                </div>
                
                <h3 style="color: #4ecdc4; margin: 20px 0 10px 0;">リロール</h3>
                <div class="abilities-grid">
                    <div class="checkbox-group">
                        <input type="checkbox" id="rerollHits1">
                        <label for="rerollHits1">ヒット1をリロール</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="rerollAllHits">
                        <label for="rerollAllHits">全命中をリロール</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="rerollWounds1">
                        <label for="rerollWounds1">ウーンズ1をリロール</label>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>防御側プロファイル</h2>
                
                <div class="input-group">
                    <label>モデル数</label>
                    <input type="number" id="models" min="1" max="30" value="5">
                </div>
                
                <div class="input-group">
                    <label>耐久力 (T)</label>
                    <input type="number" id="toughness" min="1" max="20" value="4">
                </div>
                
                <div class="input-group">
                    <label>アーマーセーブ (Sv) <span class="tooltip" data-tooltip="例：3+の場合は3を入力">?</span></label>
                    <select id="save">
                        <option value="2">2+</option>
                        <option value="3" selected>3+</option>
                        <option value="4">4+</option>
                        <option value="5">5+</option>
                        <option value="6">6+</option>
                        <option value="7">なし</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>スペシャルセーブ <span class="tooltip" data-tooltip="貫通を無視する特殊セーブ">?</span></label>
                    <select id="invulSave">
                        <option value="7" selected>なし</option>
                        <option value="2">2++</option>
                        <option value="3">3++</option>
                        <option value="4">4++</option>
                        <option value="5">5++</option>
                        <option value="6">6++</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>傷数 (W)</label>
                    <input type="number" id="wounds" min="1" max="24" value="2">
                </div>
                
                <div class="input-group">
                    <label>FNP</label>
                    <select id="fnp">
                        <option value="7" selected>なし</option>
                        <option value="2">2+++</option>
                        <option value="3">3+++</option>
                        <option value="4">4+++</option>
                        <option value="5">5+++</option>
                        <option value="6">6+++</option>
                    </select>
                </div>
                
                <div class="checkbox-group" style="margin-top: 20px;">
                    <input type="checkbox" id="inCover">
                    <label for="inCover">遮蔽あり（射撃のみ）</label>
                </div>
            </div>
        </div>
        
        <button onclick="simulate()">シミュレーション実行</button>
        
        <div class="results" id="results" style="display: none; margin-top: 30px;">
            <h2>シミュレーション結果</h2>
            
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgHits">-</div>
                    <div class="stat-label">平均ヒット数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgWounds">-</div>
                    <div class="stat-label">平均ウーンズ数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgDamage">-</div>
                    <div class="stat-label">平均ダメージ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgKills">-</div>
                    <div class="stat-label">平均撃破数</div>
                </div>
            </div>
            
            <div id="damageChart">
                <canvas id="chartCanvas"></canvas>
            </div>
            
            <div id="warnings"></div>
        </div>
    </div>
    
    <script>
        let chart = null;
        
        function rollDice() {
            return Math.floor(Math.random() * 6) + 1;
        }
        
        function checkHit(targetRoll, reroll1s, rerollAll) {
            let roll = rollDice();
            
            if (rerollAll && roll < targetRoll) {
                roll = rollDice();
            } else if (reroll1s && roll === 1) {
                roll = rollDice();
            }
            
            return {
                success: roll >= targetRoll || roll === 6,
                critical: roll === 6,
                roll: roll
            };
        }
        
        function checkWound(strength, toughness, reroll1s, twinLinked) {
            let targetRoll;
            
            if (strength >= toughness * 2) {
                targetRoll = 2;
            } else if (strength > toughness) {
                targetRoll = 3;
            } else if (strength === toughness) {
                targetRoll = 4;
            } else if (strength <= toughness / 2) {
                targetRoll = 6;
            } else {
                targetRoll = 5;
            }
            
            let roll = rollDice();
            
            if ((reroll1s && roll === 1) || twinLinked) {
                const reroll = rollDice();
                if (twinLinked || roll === 1) {
                    roll = reroll;
                }
            }
            
            return {
                success: roll >= targetRoll || roll === 6,
                critical: roll === 6,
                roll: roll
            };
        }
        
        function checkSave(save, ap, invulSave, inCover) {
            let modifiedSave = save - ap;
            
            if (inCover) {
                modifiedSave -= 1;
            }
            
            const effectiveSave = Math.min(modifiedSave, invulSave);
            
            if (effectiveSave > 6) {
                return false;
            }
            
            const roll = rollDice();
            return roll >= effectiveSave && roll !== 1;
        }
        
        function checkFnP(fnpValue) {
            if (fnpValue >= 7) return false;
            return rollDice() >= fnpValue;
        }
        
        function runSimulation() {
            const attacks = parseInt(document.getElementById('attacks').value);
            const hitRoll = parseInt(document.getElementById('hitRoll').value);
            const strength = parseInt(document.getElementById('strength').value);
            const ap = parseInt(document.getElementById('ap').value);
            const damage = parseInt(document.getElementById('damage').value);
            const toughness = parseInt(document.getElementById('toughness').value);
            const save = parseInt(document.getElementById('save').value);
            const invulSave = parseInt(document.getElementById('invulSave').value);
            const wounds = parseInt(document.getElementById('wounds').value);
            const models = parseInt(document.getElementById('models').value);
            const fnp = parseInt(document.getElementById('fnp').value);
            
            const sustainedHits = document.getElementById('sustainedHits').checked;
            const lethalHits = document.getElementById('lethalHits').checked;
            const devastatingWounds = document.getElementById('devastatingWounds').checked;
            const twinLinked = document.getElementById('twinLinked').checked;
            const rerollHits1 = document.getElementById('rerollHits1').checked;
            const rerollAllHits = document.getElementById('rerollAllHits').checked;
            const rerollWounds1 = document.getElementById('rerollWounds1').checked;
            const inCover = document.getElementById('inCover').checked;
            
            const iterations = 10000;
            const results = {
                hits: 0,
                wounds: 0,
                damage: 0,
                kills: 0,
                damageDistribution: {}
            };
            
            for (let sim = 0; sim < iterations; sim++) {
                let totalHits = 0;
                let totalWounds = 0;
                let totalDamage = 0;
                let modelsKilled = 0;
                let currentModelWounds = wounds;
                
                // Process each attack
                for (let i = 0; i < attacks; i++) {
                    const hitResult = checkHit(hitRoll, rerollHits1, rerollAllHits);
                    
                    if (!hitResult.success) continue;
                    
                    let hits = 1;
                    if (sustainedHits && hitResult.critical) {
                        hits = 2;
                    }
                    
                    for (let h = 0; h < hits; h++) {
                        totalHits++;
                        
                        let wound = false;
                        let criticalWound = false;
                        
                        if (lethalHits && hitResult.critical) {
                            wound = true;
                        } else {
                            const woundResult = checkWound(strength, toughness, rerollWounds1, twinLinked);
                            wound = woundResult.success;
                            criticalWound = woundResult.critical;
                        }
                        
                        if (!wound) continue;
                        
                        totalWounds++;
                        
                        let damageInflicted = 0;
                        
                        if (devastatingWounds && criticalWound) {
                            // Mortal wounds bypass saves
                            damageInflicted = damage;
                        } else {
                            const saved = checkSave(save, ap, invulSave, inCover);
                            if (!saved) {
                                damageInflicted = damage;
                            }
                        }
                        
                        // Apply Feel No Pain
                        if (damageInflicted > 0 && fnp < 7) {
                            let finalDamage = 0;
                            for (let d = 0; d < damageInflicted; d++) {
                                if (!checkFnP(fnp)) {
                                    finalDamage++;
                                }
                            }
                            damageInflicted = finalDamage;
                        }
                        
                        totalDamage += damageInflicted;
                        
                        // Allocate damage
                        while (damageInflicted > 0 && modelsKilled < models) {
                            if (damageInflicted >= currentModelWounds) {
                                damageInflicted -= currentModelWounds;
                                modelsKilled++;
                                currentModelWounds = wounds;
                            } else {
                                currentModelWounds -= damageInflicted;
                                damageInflicted = 0;
                            }
                        }
                    }
                }
                
                results.hits += totalHits;
                results.wounds += totalWounds;
                results.damage += totalDamage;
                results.kills += modelsKilled;
                
                if (!results.damageDistribution[totalDamage]) {
                    results.damageDistribution[totalDamage] = 0;
                }
                results.damageDistribution[totalDamage]++;
            }
            
            // Calculate averages
            results.avgHits = results.hits / iterations;
            results.avgWounds = results.wounds / iterations;
            results.avgDamage = results.damage / iterations;
            results.avgKills = results.kills / iterations;
            
            return results;
        }
        
        function simulate() {
            const results = runSimulation();
            
            // Update display
            document.getElementById('avgHits').textContent = results.avgHits.toFixed(2);
            document.getElementById('avgWounds').textContent = results.avgWounds.toFixed(2);
            document.getElementById('avgDamage').textContent = results.avgDamage.toFixed(2);
            document.getElementById('avgKills').textContent = results.avgKills.toFixed(2);
            
            // Create damage distribution chart
            const damageValues = Object.keys(results.damageDistribution).map(d => parseInt(d)).sort((a, b) => a - b);
            const probabilities = damageValues.map(d => (results.damageDistribution[d] / 10000 * 100));
            
            if (chart) {
                chart.destroy();
            }
            
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: damageValues.map(d => d.toString()),
                    datasets: [{
                        label: 'ダメージ分布',
                        data: probabilities,
                        backgroundColor: 'rgba(255, 107, 107, 0.8)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ダメージ確率分布',
                            color: '#e0e0e0',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `確率: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '総ダメージ',
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '確率 (%)',
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Show warnings
            const warningsDiv = document.getElementById('warnings');
            warningsDiv.innerHTML = '';
            
            if (document.getElementById('lethalHits').checked && document.getElementById('devastatingWounds').checked) {
                warningsDiv.innerHTML += '<div class="warning">注意：会心ヒットと会心ウーンズの組み合わせは非常に強力です。会心ヒットは自動的に負傷を与えますが、クリティカル負傷にはなりません。</div>';
            }
            
            document.getElementById('results').style.display = 'block';
        }
    </script>
</body>
</html>